---
title: "Footy Tipper Pipeline"
output:
  html_document:
    df_print: paged
---

```{r, warning=FALSE, message=FALSE, include=FALSE}
library(here)
library(skimr)
library(Epi)
library(pROC)
library(googledrive)
library(scales)

drive_auth()

i_am("pipeline/footy-tipper.Rmd")

helper_functions <- list.files(paste0(here(), "/R"), pattern = "*.R$", 
                               full.names = TRUE, ignore.case = TRUE)

sapply(helper_functions, source, .GlobalEnv)
```

# Get and split the dataset

```{r, warning=FALSE, message=FALSE}
footy_tipping_data <- get_data(year_span = year_span) %>%
  clean_data() %>%
  feature_engineering(form_period = form_period, pipeline = pipeline) %>%
  elo_variables(carry_over = carry_over, k_val = k_val, elo_init = elo_init) %>%
  filter(competition_year != min(competition_year),
         !is.na(team_head_to_head_odds_away)) %>%
  group_by(game_state_name) %>%
  group_split()

train_df <- footy_tipping_data[[1]]

inference_df <- footy_tipping_data[[2]] %>%
  filter(round_id == min(round_id))

skim(train_df)
```

# Train the model

```{r, warning=FALSE, message=FALSE}
cv <- train_multiclass_model(data = train_df, 
                             predictors = predictors, 
                             outcome_var = outcome_var, 
                             opt_metric = opt_metric)

model <- cv$finalModel
outputs <- model_properties(model, train_df, positive)
```

```{r}
outputs$confusion_matrix
```

```{r, warning=FALSE, message=FALSE}
outputs$importance
```

```{r}
outputs$round_performance
```

```{r}
outputs$benchmarking
```

```{r}
outputs$model_lift
```


# Predict the results for the round

```{r, warning=FALSE, message=FALSE}
predictions <- make_predicitons(inference_df, model, predictors, outcome_var)
predictions
```

# Save them to the drive

```{r}
save_predictions(predictions, inference_df)
```

# extra thangs...

```{r}
punt_thresholds <- predictions %>%
  mutate(home_odds_thresh = 1/home_team_win_prob,
         away_odds_thresh = 1/home_team_lose_prob)

home_picks <- punt_thresholds %>%
  filter(home_team_result == 'Win') %>%
  select(team_home, team_head_to_head_odds_home, home_odds_thresh) %>%
  rename(team = team_home, price = team_head_to_head_odds_home, price_min = home_odds_thresh)

away_picks <- punt_thresholds %>%
  filter(home_team_result == 'Loss') %>%
  select(team_away, team_head_to_head_odds_away, away_odds_thresh) %>%
  rename(team = team_away, price = team_head_to_head_odds_away, price_min = away_odds_thresh)

levons_picks <- bind_rows(home_picks, away_picks) %>%
  filter(price > price_min) %>%
  mutate_if(is.numeric, dollar)

levons_picks
```
