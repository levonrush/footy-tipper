---
title: "Footy Tipper Pipeline"
output: html_notebook
---

```{r, warning=FALSE, message=FALSE}
setup_env()
```

# Get and split the dataset

```{r, warning=FALSE, message=FALSE}
footy_tipping_data <- get_data(year_span) %>%
  clean_data() %>%
  feature_engineering(form_period, pipeline) %>%
  elo_variables() %>%
  filter(competition_year != min(competition_year)) %>%
  group_by(game_state_name) %>%
  group_split()

train_df <- footy_tipping_data[[1]]

inference_df <- footy_tipping_data[[2]] %>%
  filter(round_id == min(round_id))

skim(train_df)
```

# Train the model

```{r, warning=FALSE, message=FALSE}
cv <- train_multiclass_model(data = train_df, predictors, outcome_var, opt_metric)

model <- cv$finalModel
```

```{r}
model$confusion[-1,2:3] %>% confusionMatrix(positive = positive)
```

```{r, warning=FALSE, message=FALSE}
importance(model) %>% t() %>% .[1,] %>% 
  as.tibble(rownames = "variable") %>%
  arrange(desc(value)) %>%
  ggplot(aes(x = variable, y = value, fill = variable)) +
  geom_bar(stat = "identity") +
    coord_flip() +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Importance of variables",
       x = NULL, y = "Importance")
```

# Predict the results for the round

```{r, warning=FALSE, message=FALSE}
predictions <- make_predicitons(inference_df, model, predictors, outcome_var)

predictions
```

# Save them to the drive

```{r}
save_predictions(inference_df, predictions)
```
