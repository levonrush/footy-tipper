---
title: "Footy Tipper Pipeline"
---

```{r, warning=FALSE, message=FALSE, include=FALSE}
# define where the pipeline lives
library(here)
i_am("footy-tipper.Rmd")

# find and load all the helper functions for the project
helper_functions <- list.files(paste0(here(), "/R"), pattern = "*.R$",
                               full.names = TRUE, ignore.case = TRUE)

sapply(helper_functions, source, .GlobalEnv)

# load the project secrets
load_dot_env(file = "secrets.env")

# authenticate google drive with our service account
#drive_auth(path = "/footy-tipper/footy-tipper-c5bcb9639ee2.json")

# define what type of run we're doing
detect_set_environment(prod_run = F) 
```

# Get and split the dataset

```{r, warning=FALSE, message=FALSE}
footy_tipping_data <- data_pipeline(year_span, pipeline, form_period, carry_over, k_val, elo_init)

train_df <- footy_tipping_data$train_df
inference_df <- footy_tipping_data$inference_df

skim(train_df)
```

```{r, warning=FALSE, message=FALSE}
opt_predictors <- perform_rfe(data = train_df, k = 5, opt_metric, maximise = T, steps = NULL, outcome_var = outcome_var, predictors = predictors) 
opt_predictors
```

# Train the model

```{r, warning=FALSE, message=FALSE}
cv <- train_multiclass_model(data = train_df, predictors = opt_predictors, outcome_var = outcome_var, opt_metric = opt_metric)

model <- cv$finalModel
outputs <- model_properties(model, train_df, inference_df, positive)

outputs$confusion_matrix
outputs$importance
outputs$round_performance
outputs$benchmarking
outputs$model_lift
```

# Predict the results for the round

```{r, warning=FALSE, message=FALSE}
predictions <- make_predicitons(inference_df, model, predictors, outcome_var)
predictions
```

# Save them to the drive

```{r}
save_predictions(predictions, inference_df, prod_run = prod_run)
```

# extra thangs...

```{r}
levons_picks(predictions, prod_run = prod_run)
```
