---
title: "Creating new features"
output: html_notebook
---

```{r, warning=FALSE, message=TRUE}
library(here)
library(lubridate)

i_am("research/creating-new-features.Rmd")

source(paste0(here(),"/R/get-data.R"))

footy_tipper_df <- get_data(year_span = 2012:2023) 
 
footy_tipper_df
```
# corona season

an easy one aimed at reducing bias from a weird season

```{r}
footy_tipper_df <- footy_tipper_df %>%
  mutate(corona_season = ifelse(competition_year == 2020, 1, 0))
```

# Seasonality Variables

```{r}
footy_tipper_df <- footy_tipper_df %>%
  mutate(start_hour = hour(start_time))
```

# Form variables

## seasonal vars
* home record (as a number)
* away record (as a number)
* season record (as a number)
* points for
* points against
* point diff

```{r}
home_record <- footy_tipper_df %>%
  select(game_id, competition_year, team_home, team_final_score_home, team_final_score_away, home_team_result) %>%
  rename(team = team_home, points_for = team_final_score_home, points_against = team_final_score_away) %>%
  arrange(game_id) %>%
  group_by(team, competition_year) %>%
  mutate(home_record =
           cumsum(case_when(
             home_team_result == 'Win'  ~ 1, 
             home_team_result == 'Loss' ~ -1,
             TRUE                       ~ 0)),
         points_for = cumsum(points_for),
         points_against = cumsum(points_against),
         points_diff = points_for - points_against) %>%
  mutate_at(vars(home_record, points_for, points_against, points_diff), lag) %>%
  replace(is.na(.), 0) %>%
  ungroup() %>%
  select(-c(competition_year, home_team_result))



away_record <- footy_tipper_df %>%
  select(game_id, competition_year, team_away, team_final_score_home, team_final_score_away, home_team_result) %>%
  rename(team = team_away, points_for = team_final_score_away, points_against = team_final_score_home) %>%
  arrange(game_id) %>%
  group_by(team, competition_year) %>%
  mutate(away_record =
           cumsum(case_when(
             home_team_result == 'Win'  ~ -1, 
             home_team_result == 'Loss' ~ 1,
             TRUE                       ~ 0)),
         points_for = cumsum(points_for),
         points_against = cumsum(points_against),
         points_diff = points_for - points_against) %>%
  mutate_at(vars(away_record, points_for, points_against, points_diff), lag) %>%
  replace(is.na(.), 0) %>%
  ungroup() %>%
  select(-c(competition_year, home_team_result))

season_record <- home_record %>%
  left_join(away_record, by = "game_id", suffix = c("_home", "_away")) %>%
  mutate(season_record = home_record + away_record,
         points_for_season = points_for_home + points_for_away,
         points_against_season = points_against_home + points_against_away,
         points_diff_season = points_for_season - points_against_season)

footy_tipper_df <- footy_tipper_df %>%
  left_join(season_record)

footy_tipper_df
```


## recency vars


## opponent vars








































